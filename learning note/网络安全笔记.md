# web安全学习笔记

## 网络安全观

### 保护对象

1. 软件
2. 硬件
3. 数据

### 基本需求

1. 可靠性

2. **可用性**

   信息资源可被授权实体按要求访问、正常使用或在非正常情况下能恢复使用的特性。在系统运行时正确存取所需信息，当系统遭受意外攻击或破坏时，可以迅速恢复并能投入使用。是衡量网络信息系统面向用户的一种安全性能，以保障为用户提供服务。

3. **保密性**

   不将有用信息泄漏给非授权用户的特性。可以通过信息加密、身份认证、访问控制、安全通信协议等技术实现，信息加密是防止信息非法泄露的最基本手段，主要强调有用信息只被授权对象使用的特征。

4. **完整性**

   信息在传输、交换、存储和处理过程中，保持信息不被破坏或修改、不丢失和信息未经授权不能改变的特性，也是最基本的安全特征。

5. 不可抵赖性

6. 可控性

7. 可审查性

8. 真实性

### 系统脆弱性

1. 硬件脆弱性：物理安全
2. 软件脆弱性：软件设计、信息安全



## 计算机网络与协议

### 分层

网络协议分层，每层负责不同的通信：

1. 链路层：设备驱动程序、网卡，处理与电缆的物理接口细节，ARP\RARP

2. 网络层：处理分组在网络中的活动，IP协议、ICMP协议、IGMP协议

3. 运输层：端到端的通信协议，TCP协议、UDP协议

4. 应用层：通信应用处理，FTP协议、Telnet、SMTP

   ![image-20210421142442403](E:\学习笔记\web安全学习笔记\网络安全笔记.assets\image-20210421142442403.png)

![image-20210421142941149](E:\学习笔记\web安全学习笔记\网络安全笔记.assets\image-20210421142941149.png)

#### 封装

帧Frame：以太网传输的比特流，46~1500 bytes(octet)

IP数据报IP datagram: IP层传给链路层的数据单元, 可能会有IP分组

TCP段TCP segment: TCP层传给IP层的数据单元

![image-20210421145447407](E:\学习笔记\web安全学习笔记\网络安全笔记.assets\image-20210421145447407.png)

#### 分用

每层协议都要去检查报文首部中的协议标志，以确定接受数据的上层协议，这个过程叫做分用Demultiplexing。

![image-20210421150334697](E:\学习笔记\web安全学习笔记\网络安全笔记.assets\image-20210421150334697.png)

### 网络地址 

![image-20210421143226440](E:\学习笔记\web安全学习笔记\网络安全笔记.assets\image-20210421143226440.png)

A类：0.0.0.0-127.255.255.255

B类：128.0.0.0-191.255.255.255

C类：192.0.0.0-223.255.255.255

D类：224.0.0.0-239.255.255.255， 组播地址

E类：240.0.0.0-247.255.255.255，特殊保留地址

特殊IP：#todo 

​    127.0.0.1, 0.0.0.0-本机地址

   ![image-20210426145606257](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210426145606257.png)

广播地址： 

​	直接广播地址：A、B、C类IP地址，主机号全1

​    受限广播地址：255.255.255.255

留用的内部私有地址

   A类 10.0.0.0--10.255.255.255

   B类 172.16.0.0--172.31.255.255

   C类 192.168.0.0--192.168.255.255

### 链路层

链路层协议： 

####     以太网链路层协议

![image-20210423154239523](E:\学习笔记\web安全学习笔记\网络安全笔记.assets\image-20210423154239523.png)

####     令牌环网

![image-20210425093151162](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210425093151162.png)

​    FDDI（光纤分布式数据接口）

####     RS-232串行线路（SLIP、PPP）

![image-20210425092921261](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210425092921261.png)

####    最大传输单元MTU

   MTU（maximum transport unit）

​    ![image-20210425094433705](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210425094433705.png)

![image-20210425094717866](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210425094717866.png)

#### 路径MTU

两台通信主机路径中的最小MTU---路径MTU

路径MTU的发现机制（rfc1191）#todo

#### 串行线路吞吐量计算（不是很懂）



### IP（网际协议）

IP提供不可靠、无连接的数据报传送

**不可靠（unreliable）的意思是它不能保证IP数据报能成功地到达目的地。**IP仅提供最好的传输服务。如果发生某种错误时，如某个路由器暂时用完了缓冲区， IP有一个简单的错误处理算法：丢弃该数据报，然后发送ICMP消息报给信源端。任何要求的可靠性必须由上层来提供（如TCP）。

无连接（connection less）这个术语的意思是**IP并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。这也说明，IP数据报可以不按发送顺序接收。**如果一信源向相同的信宿发送两个连续的数据报（先是A，然后是B），每个数据报都是独立地进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达。

#### IP首部（IPv4）

![image-20210425110907576](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210425110907576.png)

##### 大端、小端

大端： 网络字节序（网络、文件存储时）

小端：主机字节序（大多数机器是小端，便于机器从低位计算）

CPU读取数据是从低字节向高字节读取，存储时从高字节向低字节存储；

![image-20210425112629974](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210425112629974.png)

##### 字段含义

4bit **版本(Version)**： 4

4bit **首部长度(Internet Header Length, IHL)**：4byte首部长度的N倍---可以标志 0~4*15byte的首部长度，所以IP首部最长为60byte，一般为20byte

8bit **服务类型(Type of Service, TOS)**: 

--------------------------

7     6     5           |      4               3                    2                 1        |    0

优先权子字段    |最小时延   最大吞吐量  最高可靠性 最小费用 | 未用位

----------------------------------------------------------------

![image-20210425140711397](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210425140711397.png)

16bit **总长度（Total Length, TL）**(字节数): 指整个IP数据报的长度，以字节为单位。利用首部长度字段和总长度字段，就可以知道IP数据报中数据内容的起始位置和长度。范围是20~65535 bytes, 

​    但是主机一般要求数据报小于576 byte；（RIP，TFTP，BOOTP，DNS，以及SNMP）限制用户数据报长度为512字节，小于576字节；事实上现在大多数的实现（特别是那些支持网络文件系统NFS的实现）允许超过8192字节的IP数据报。

16 bit **标识字段(Identification)**: 唯一地标识主机发送的每一份数据报。通常每发送一份报文它的值就会加1。

​    RFC 791 [Postel 1981a]认为标识字段应该由让IP发送数据报的上层来选择。假设有两个连续的IP数据报，其中一个是由TCP生成的，而另一个是由UDP生成的，那么它们可能具有相同的标识字段。尽管这也可以照常工作（由重组算法来处理），但是在大多数从伯克利派生出来的系统中，每发送一个IP数据报，IP层都要把一个内核变量的值加1，不管交给IP的数据来自哪一层。内核变量的初始值根据系统引导时的时间来设置。

3bit **标志字段（Flags）**：这是当封包在传输过程中进行最佳组合时使用的3个bit的识别记号｡这三位同一时刻也是只能有一个位的值能设置为1。

​    ◆R: 0..(Reserved Fragment):保留分段｡

​    ◆D: .0.(Don't Fragment):不分段｡当此值为0的时候表示封包可以被分段,如果为1则不能被分割｡ 

​    ◆M: ..0( More Fragment):更多分段｡当上一个值为0时,此值为0就示该封包是最後一个封包,如果为1则表示其後还有被分割的封包｡

13bit **分段偏移（Fragment Offset, FO）**：分片数据在原数据中的相对位置，以8字节为单位（16bit TL/ 13 bit FO）。

8 bit **生存时间（time-to-live， TTL）**: 设置了数据报可以经过的最多路由器数。它指定了数据报的生存时间。TTL的初始值由源主机设置（通常为32或64），一旦经过一个处理它的路由器，它的值就减去1。当该字段的值为0时，数据报就被丢弃，并发送ICMP报文通知源主机。

8bit **协议（Protocol，PROT）**: 

![image-20210425163441080](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210425163441080.png)

16bit **首部校验和（Header Checksum）**:根据IP首部计算的检验和码。它不对首部后面的数据进行计算。ICMP、IGMP、UDP和TCP在它们各自的首部中均含有同时覆盖首部和数据检验和码。

为了计算一份数据报的IP检验和，首先把检验和字段置为0。然后，对首部中每个16 bit进行二进制反码求和（整个首部看成是由一串16 bit的字组成），结果存在检验和字段中。当收到一份IP数据报后，同样对首部中每个16bit进行二进制反码的求和。由于接收方在计算过程中包含了发送方存在首部中的检验和，因此，如果首部在传输过程中没有发生任何差错，那么接收方计算的结果应该为全1。如果结果不是全1（即检验和错误），那么IP就丢弃收到的数据报。但是不生成差错报文，由上层去发现丢失的数据报并进行重传。

ICMP、IGMP、UDP和TCP都采用相同的检验和算法，尽管TCP和UDP除了本身的首部和数据外，在IP首部中还包含不同的字段。在RFC 1071[Braden, Borman and Patridge 1988]中有关于如何计算Internet检验和的实现技术。**由于路由器经常只修改TTL字段（减1），因此当路由器转发一份报文时可以增加它的检验和，而不需要对IP整个首部进行重新计算。**RFC 1141[Mallory and Kullberg 1990]为此给出了一个很有效的方法。

**任选项**: 数据报中的一个可变长的可选信息。目前，这些任选项定义如下：

```
• 安全和处理限制（用于军事领域，详细内容参见RFC 1108[Kent 1991]）
• 记录路径（让每个路由器都记下它的I P地址，见7.3节）
• 时间戳（让每个路由器都记下它的I P地址和时间，见7.4节）
• 宽松的源站选路（为数据报指定一系列必须经过的I P地址，见8.5节）
• 严格的源站选路（与宽松的源站选路类似，但是要求只能经过指定的这些地址，不能经过其他的地址）。
```

这些选项很少被使用，并非所有的主机和路由器都支持这些选项。*选项字段一直都是以32 bit作为界限，在必要的时候插入值为0的填充字节。这样就保证IP首部始终是32 bit的整数倍（这是首部长度字段所要求的）*。

#### IP路由选择 ####

当今的大多数多用户系统，包括几乎所有的Unix系统，都可以配置成一个路由器。我们可以为它指定主机和路由器都可以使用的简单路由算法。**本质上的区别在于主机从不把数据报从一个接口转发到另一个接口，而路由器则要转发数据报。**内含路由器功能的主机应该从不转发数据报，除非它被设置成那样。——可以选择是否开启forward功能，一般主机为了减少网卡压力，不forward。

IP路由选择是**逐跳地（hop-by-hop）**进行的。从这个路由表信息可以看出， IP并不知道到达任何目的的完整路径（当然，除了那些与主机直接相连的目的）。所有的IP路由选择只为数据报传输提供下一站路由器的I P地址。它假定下一站路由器比发送数据报的主机更接近目的，
而且下一站路由器与该主机是直接相连的。

**IP路由选择主要完成以下这些功能：**

```
1) 搜索路由表，寻找能与目的IP地址完全匹配的表目（网络号和主机号都要匹配）。如果找到，则把报文发送给该表目指定的下一站路由器或直接连接的网络接口（取决于标志字段的值）。
2) 搜索路由表，寻找能与目的网络号相匹配的表目。如果找到，则把报文发送给该表目指定的下一站路由器或直接连接的网络接口（取决于标志字段的值）。目的网络上的所有主机都可以通过这个表目来处置。例如，一个以太网上的所有主机都是通过这种表目进行寻径的。这种搜索网络的匹配方法必须考虑可能的子网掩码。关于这一点我们在下一节中进行讨论。
3) 搜索路由表，寻找标为“默认（default）”的表目。如果找到，则把报文发送给该表目指定的下一站路由器。为一个网络指定一个路由器，而不必为每个主机指定一个路由器，这是IP路由选择机制的另一个基本特性。这样做可以极大地缩小路由表的规模，比如Internet上的路由器有只有几千个表目，而不会是超过100万个表目。
```

如果上面这些步骤都没有成功，那么该数据报就不能被传送。如果不能传送的数据报来自本机，那么一般会向生成数据报的应用程序返回一个“主机不可达”或“网络不可达”的错误。

在路由选择中：

1. IP首部的 目的IP地址始终不会发生变化（在8.5节中，我们将看到，只有使用源路由选项时，目的IP地址才有可能被修改，但这种情况很少出现），所有的路由选择决策都是基于这个目的IP地址的；

   #todo 那在路由转发中， IP首部的 源IP地址是否会发生变化呢？

   

2. 每个链路层可能具有不投的数据帧首部，链路层的目的地址（如果有的话， SLIP并没有链路层首部）始终为下一站的链路层地址MAC。







![image-20210426134829521](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210426134829521.png)

输出项 说明 
Destination 目标网段或者主机 
Gateway 网关地址，”*” 表示目标是本主机所属的网络，不需要路由 
Genmask 网络掩码 
Flags 标记。一些可能的标记如下： 
 U — 路由是活动的 
 H — 目标是一个主机 
 G — 路由指向网关 
 R — 恢复动态路由产生的表项 
 D — 由路由的后台程序动态地安装 
 M — 由路由的后台程序修改 
 ! — 拒绝路由 
Metric 路由距离，到达指定网络所需的中转数（linux 内核中没有使用） 
Ref 路由项引用次数（linux 内核中没有使用） 
Use 此路由项被路由软件查找的次数 
Iface 该路由表项对应的输出接口



#### 子网寻址

#### **子网掩码**

IP/Mask----- 网络号 |子网号 | 主机号

给定IP地址和子网掩码以后，主机就可以确定IP数据报的目的是：

(1)本子网上的主机；

(2)本网络中其他子网中的主机；

(3)其他网络上的主机。如果知道本机的I P地址，那么就知道
它是否为A类、B类或C类地址(从IP地址的高位可以得知)，也就知道网络号和子网号之间的分界线。而根据子网掩码就可知道子网号与主机号之间的分界线。

![image-20210426145259843](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210426145259843.png)

RFC 1009[Braden and Postel 1987]允许一个含有子网的网络使用多个子网掩码。新的路由器需求RFC[Almquist 1993]则要求支持这一功能。

但是，问题在于并不是所有的路由选择协议在交换目的网络时也交换子网掩码。

在第10章中，我们将看到RIP不支持变长子网，RIP第2版和OSPF则支持变长子网。

#todo, 不是很懂

#### 特殊情况的IP地址

[详见](#网络地址)

#### ifconfig命令

![image-20210426151245063](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210426151245063.png)

http://www2.phys.canterbury.ac.nz/dept/docs/manuals/unix/DEC_5.0a_Docs/HTML/MAN/MAN8/0162____.HTM

https://man7.org/linux/man-pages/man8/ifconfig.8.html

#### netstat命令

![image-20210426153427070](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210426153427070.png)

这个命令打印出每个接口的MTU、输入分组数、输入错误、输出分组数、输出错误、冲突以及当前的输出队列长度。

https://man7.org/linux/man-pages/man8/netstat.8.html

#### 问答

3.5子网掩码255.255.0.255是否对A类地址有效？
  答：它是合法的，被称为非连续的子网掩码，因为其用于子网掩码的16位是不连续的。但是RFC建议反对使用非连续的子网掩码。

3.6你认为为什么3.9小节中打印出来的环回接口的MTU要设置为1536？
  答：这是一个历史遗留问题。值是1024＋512，但是打印的M T U值包含了所有需要的首部字
节数。Solaris 2.2将回环接口的MTU设置为8 2 3 2（8 1 9 2＋4 0），其中包含了8192字节的用
户数据加上20字节的IP首部和20字节的TCP首部。

### ARP（Address Resolution Protocol）

### RARP(Reverse Address Resolution Protocol)

![image-20210426160444201](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210426160444201.png)

ARP为IP地址到对应的硬件地址之间提供动态映射。我们之所以用动态这个词是因为这个过程是自动完成的，一般应用程序用户或系统管理员不必关心。（点对点链路不使用ARP。当设置这些链路时（一般在引导过程进行），必须告知内核链路每一端的IP地址。像以太网地址这样的硬件地址并不涉及。）

RARP是被那些没有磁盘驱动器的系统使用（一般是无盘工作站或X终端），它需要系统管理员进行手工设置。

![image-20210426160944796](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210426160944796.png)

#### ARP、RARP的分组格式

![image-20210426161137778](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210426161137778.png)

以太网目的地址：目的地址为全1的特殊地址是广播地址。电缆上的所有以太网接口都要接收广播的数据帧。

以太网源地址： 发送端的MAC地址

帧类型（0x806: ARP, 0X8035: RARP）[参考](#以太网链路层协议)



硬件类型：1： 以太网地址

协议类型：要映射的协议地址类型，0x800: IP地址

硬件地址长度：硬件地址的长度，以字节为单位（MAC: 6 byte）

协议地址长度：协议地址的长度，以字节为单位（IP: 4 byte）

op：操作类型：1：ARP请求；

​                           2： ARP应答；

​                           3：RARP请求；

​                          4： RARP应答。

发送端以太网地址：

发送端IP地址：

目的以太网地址：

目的IP地址：

![image-20210427174227644](E:\Design Pattern\Learn-Web-Hacking\learning note\网络安全笔记.assets\image-20210427174227644.png)

https://www.lixu.ca/2014/10/linux-arp-and-how-to-tcpdump-arp.html

  [tcpArp.cap](tcpArp.cap) 





### UDP



### TCP





### Question

为什么 “一般来说 TCP服务器是并发的，UDP服务器是重复的（非并发，阻塞式）,但也存在一些例外”？ P9, todo

### DNS

Domain Name System 域名系统，是一个分布的数据库，提供IP和主机名之间的映射信息。







## todo

端口 /etc/services

FTP: tcp 21

Telnet: tcp 23

TFTP: udp 69

![image-20210422140245774](E:\学习笔记\web安全学习笔记\网络安全笔记.assets\image-20210422140245774.png)





