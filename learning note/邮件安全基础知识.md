# 邮件安全基础知识

## 邮件基本流程

### 术语

MUA(Mail User Agent)：email client, 例如 Outlook, thunderbird, Gmail等邮件应用

MTA(Mail Transfer Agent)：邮件传输服务器，负责接收、传递邮件的应用，例如Exchange Server, IBM Lotus 

MDA(Mail Deliver Agent): 将MTA接收到的邮件保存到指定位置，通常会进行邮件扫描，例如dropmail, procmail[都没用过- -]；

MRA(Mail Receive Agent): 通过IMAP/POP3协议与MUA进行交互，取得MDA存储的邮件，例如 dovecot[都没用过- -]；

MSA(Mail Submission Agent): 邮件发送服务器（其实和MTA类似，可能配置不一样）；

[Mail Server对比](https://en.wikipedia.org/wiki/Comparison_of_mail_servers)

### 邮件收发流程

[refer](https://en.wikipedia.org/wiki/Message_transfer_agent)

Every time an MTA receives an email message, it adds a Received trace header field to the top of the header of the message, thereby building a sequential record of MTAs handling the message. 

For recipients hosted locally, the final delivery of email to a recipient mailbox is the task of a [message delivery agent](https://en.wikipedia.org/wiki/Message_delivery_agent) (MDA). For this purpose the MTA transfers the message to the message handling service component of the message delivery agent (MDA). Upon final delivery, the Return-Path field is added to the envelop to record the [return path](https://en.wikipedia.org/wiki/Return_path). [SPF校验]

Submission of new email from a mail client is via SMTP, typically on port 587 or 465, and is now generally restricted to servers the user has an account with-such as their [ISP](https://en.wikipedia.org/wiki/ISP). This is for policy, not technical, reasons so that providers have some means of holding their users accountable for the generation of [spam](https://en.wikipedia.org/wiki/Spam_(electronic)) and other forms of email abuse. 

![image-20210526151040655](E:\Design Pattern\Learn-Web-Hacking\learning note\邮件安全基础知识.assets\image-20210526151040655.png)

![image-20210528170143015](E:\Design Pattern\Learn-Web-Hacking\learning note\邮件安全基础知识.assets\image-20210528170143015.png)

### 邮件的组成

https://bbs.huaweicloud.com/blogs/136724

```C++
/*
This SMTP example shows mail sent by Smith at host bar.com, to Jones,
Green, and Brown at host foo.com. Here we assume that host bar.com
contacts host foo.com directly. The mail is accepted for Jones and
Brown. Green does not have a mailbox at host foo.com. 
*/
S: 220 foo.com Simple Mail Transfer Service Ready
C: EHLO bar.com
S: 250-foo.com greets bar.com
S: 250-8BITMIME
S: 250-SIZE
S: 250-DSN
S: 250 HELP
C: MAIL FROM:<Smith@bar.com>
S: 250 OK
C: RCPT TO:<Jones@foo.com>
S: 250 OK
C: RCPT TO:<Green@foo.com>
S: 550 No such user here
C: RCPT TO:<Brown@foo.com>
S: 250 OK
C: DATA
S: 354 Start mail input; end with <CRLF>.<CRLF>
C: Blah blah blah...
C: ...etc. etc. etc.
C: .
S: 250 OK
C: QUIT
S: 221 foo.com Service closing transmission channel
```

1. 信封（envelope）

   信封是 MTA 用来交付的，在上例中由两个 SMTP 命令指明； 
   MAIL From: Smith@bar.com
   RCPT To: Jones@foo.com, Brown@foo.com

2. 首部（header）
   首部由用户代理使用，例如：Received、Message-Id、From、Date、Reply-To、To 和 Subject
   （以 X- 开头的是用户定义的字段，其他是由 RFC 822 定义的）

3. 正文（body）
   
   正文是发送用户发给接收用户报文的内容，[RFC 822](https://www.ietf.org/rfc/rfc822.txt) 指定正文为 [NVT ASCII](https://baike.baidu.com/item/NVT ASCII) 文字行，用 DATA 命令发送的各行都必须小于 1000 字节


用户接收我们指定为正文的部分，加上一些首部字段，并把结果传到 MTA；MTA 加上一些首部字段(Received)，加上信封，并把结果发送到另一个 MTA

## 邮件格式

### MIME(Multipurpose Internet Mail Extensions)

多用途互联网邮件扩展 https://www.cnblogs.com/chenxinshuo/p/11979159.html

将原本只支持ASCII的邮件内容进行扩展，让邮件body可以包含html，header中可以支持非ASCII字符，可以发送附件。

The MIME standard is specified in a series of [requests for comments](https://en.wikipedia.org/wiki/Request_for_Comments): [RFC 2045](https://tools.ietf.org/html/rfc2045), [RFC 2046](https://tools.ietf.org/html/rfc2046), [RFC 2047](https://tools.ietf.org/html/rfc2047), [RFC 4288](https://tools.ietf.org/html/rfc4288), [RFC 4289](https://tools.ietf.org/html/rfc4289) and [RFC 2049](https://tools.ietf.org/html/rfc2049). The integration with SMTP email is specified in [RFC 1521](https://tools.ietf.org/html/rfc1521) and [RFC 1522](https://tools.ietf.org/html/rfc1522).

`todo, 以后再看吧= =`

## 邮件相关DNS

### MX Record(Mail Exchange Record)

Resource records are the basic information element of the Domain Name System (DNS). An MX record is one of these, and a domain may have one or more of these set up, as below:

```c
  Domain			TTL   Class    Type  Priority      Host
example.com.		1936   IN	    MX	  10         onemail.example.com.
example.com.		1936   IN	    MX	  10         twomail.example.com.
```

priority(数值越小，优先级越高)会影响load balance选择对应host的权重；

取得host后，需要去查询DNS A / AAAA记录，得到host对应的ipv4/ipv6地址；且host不能有指向任何DNS CNAME record[rfc2181]。

The MX mechanism does not grant the ability to provide mail service on alternative [port numbers](https://en.wikipedia.org/wiki/Port_number), nor does it provide the ability to distribute mail delivery across a set of unequal-priority mail servers by assigning a weighting value to each one.

如果domain没有对应的mx record，则将该domain作为host去查询A/AAAA记录[RFC 5321 sec. 5.1]。

### TXT Record

txt record是DNS中的一种host对应的资源文本记录，它使用结构化的方式记录一些机器可读的文本信息，一个域名可以有多个txt record。

目前txt record扩展应用于[rfc1464]：

- Verification of domain ownership
- Implementation of [Sender Policy Framework](https://en.wikipedia.org/wiki/Sender_Policy_Framework)
- [DomainKeys Identified Mail](https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail) records for verifying the sender of [email](https://en.wikipedia.org/wiki/Email) messages
- [Zero-configuration networking DNS-based service discovery](https://en.wikipedia.org/wiki/Zero-configuration_networking#DNS-based_service_discovery)
- [DMARC](https://en.wikipedia.org/wiki/DMARC) policies

RFC 1464 defines a structured format that can be used to define attributes and their values in a single record:

```c++
   Domain		   Class   Type   Info
host.widgets.com.   IN     TXT   "printer=lpr5"
sam.widgets.com.    IN     TXT   "favorite drink=orange juice"
//SPF,v: version, ipxx: allowed send ip, a: allow, -all: forbiden other send ip
host.widgets.com.   IN     TXT   "v=spf1 ip4:192.0.2.0/24 ip4:198.51.100.123 ip6:2620:0:860::/46 a -all"
// DKIM, k: cryto, t: , p: publick key
host.widgets.com.   IN     TXT   "k=rsa; t=s; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDmzRmJRQxLEuyYiyMg4suA2Sy \
MwR5MGHpP9diNT1hRiwUd/mZp1ro7kIDTKS8ttkI6z6eTRW9e9dDOxzSxNuXmume60Cjbu08gOyhPG3 \
GfWdg7QkdN6kR4V75MFlw624VY35DaXBvnlTJTgRg/EW72O1DiYVThkyCgpSYS8nmEQIDAQAB"
// DMARC
host.widgets.com.   IN     TXT   "v=DMARC1;p=none;sp=quarantine;pct=100;rua=mailto:dmarcreports@example.com;"
// Use for site verification:
host.widgets.com.   IN     TXT   "google-site-verification=6P08Ow5E-8Q0m6vQ7FMAqAYIDprkVV8fUf_7hZ4Qvc8"
// Use for custom email service:
host.widgets.com.   IN     TXT   "pmBGN/7MjnfhTKUZ06Enqq1PeGUaOkw8lGhcfwefcHU="
```

## 邮件相关主要协议

| 协议 | TCP端口                                                      | 发送邮件     | 接收邮件 |
| ---- | ------------------------------------------------------------ | ------------ | -------- |
| SMTP | Port 587: default port for mail sending(support tcp, ssl, tls)  <br />Port 25:   default port used for relaying <br />Port 2525 used when 587 is blocked<br />Port 465 should no longer be used at all | 支持         | 不支持   |
| POP3 | Port 110:  default port<br />Port 995: POP3S for TLS, SSL connection | 不支持       | 支持     |
| IMAP | Port 143: default port<br />Port 993: IMAPS for TLS, SSL connection | 支持[不建议] | 支持     |

### POP3(Post Office Protocol version 3)

POP3【RFC1939, updated by RFC2249】是邮件客户端收取邮件到本地的应用层协议；可以让用户在连线时，可以从服务器拉取邮件，在离线时查看、处理本地的邮件。

POP3可以选择在下载邮件后，是否删除服务器上的邮件[现在大多数邮件服务器也都不会删除了]；IMAP则默认不删除服务器上的邮件，这样可以多客户端处理邮件。

POP3 port为110，使用TCP和服务器进行连接；POP3可以使用STLS command进行加密通讯；

POP3S port为995，使用TLS/SSL进行连接。

#### POP3状态迁移

| 状态名                 | 说明                                                         |
| ---------------------- | ------------------------------------------------------------ |
| AUTHORIZATION 认证状态 | tcp连接后，进行身份确认状态                                  |
| TRANSACTION 操作状态   | 身份确认成功后，服务器会获取客户邮件相关的资源并加锁（exclusive-access lock），防止邮件在操作状态结束之前被误删 |
| UPDATE 更新状态        | 操作状态结束后（QUIT），POP3服务器释放在操作状态中获取的资源并终止连接 |

![image-20210528174351432](E:\Design Pattern\Learn-Web-Hacking\learning note\邮件安全基础知识.assets\image-20210528174351432.png)

#### POP3常用命令

```C++
/*
Sample for POP3
*/
S: <wait for connection on TCP port 110>
C: <open connection>
S: +OK POP3 server ready <1896.697170952@dbc.mtview.ca.us>
C: APOP mrose c4c9334bac560ecc979e58001b3e22fb
S: +OK mrose’s maildrop has 2 messages (320 octets)
C: STAT
S: +OK 2 320
C: LIST
S: +OK 2 messages (320 octets)
S: 1 120
S: 2 200
S: .
C: RETR 1
S: +OK 120 octets
S: <the POP3 server sends message 1>
S: .
C: DELE 1
S: +OK message 1 deleted
C: RETR 2
S: +OK 200 octets
S: <the POP3 server sends message 2>
S: .
C: DELE 2
S: +OK message 2 deleted
C: QUIT
S: +OK dewey POP3 server signing off (maildrop empty)
C: <close connection>
S: <wait for next connection>
```

https://blog.csdn.net/bripengandre/article/details/2192111

*SMTP*命令不区分大小写，但参数区分大小写，有关这方面的详细说明请参考*RFC1939*。

| 场景           | 命令 | 参数        | 使用在何种状态中 | 描述                                                         |
| -------------- | ---- | ----------- | ---------------- | ------------------------------------------------------------ |
| 必须支持的命令 | USER | Username    | 认证             | 此命令与下面的pass命令若成功，将导致状态转换                 |
| 必须支持的命令 | PASS | Password    | 认证             | 此命令若成功，状态转化为更新                                 |
| 可选命令       | APOP | Name,Digest | 认证             | 用于替代 USER 和 PASS 命令，它以 MD5 数字摘要的形式向POP3邮件服务器提交帐户密码，**安全性更高** |
| 必须支持的命令 | STAT | None        | 处理             | 请求服务器发回关于邮箱的统计资料，如邮件总数和总字节数       |
| 可选命令       | UIDL | [Msg#]      | 处理             | 返回邮件的唯一标识符，POP3会话的每个标识符都将是唯一的       |
| 必须支持的命令 | LIST | [Msg#]      | 处理             | 返回邮件的唯一标识符，POP3会话的每个标识符都将是唯一的       |
| 必须支持的命令 | RETR | [Msg#]      | 处理             | 返回由参数标识的邮件的全部文本                               |
| 必须支持的命令 | DELE | [Msg#]      | 处理             | 服务器将由参数标识的邮件标记为删除，由QUIT命令执行           |
| 可选命令       | TOP  | [Msg#]      | 处理             | 服务器将返回由参数标识的邮件的邮件头+前n行内容，n必须是正整数 |
| 必须支持的命令 | NOOP | None        | 处理             | 服务器返回一个肯定的响应，用于测试连接是否成功               |
| 必须支持的命令 | RSET | None        | 处理             | 重启连接                                                     |
| 必须支持的命令 | QUIT | None        | 处理、认证       | 1)        如果服务器处于“处理”状态，么将进入“更新”状态以删除任何标记为删除的邮件，并重返“认证”状态。<br />2)        如果服务器处于“认证”状态，则结束会话，退出连接 |

POP3响应由一个状态码和一个可能跟有附加信息的命令组成。所有响应也是由CRLF对结束。现在有两种状态码，“确定” (“+OK”)和“失败”（“-ERR”）。

### IMAP(Internet Message Access Protocol)

IMAP[主要为RFC3501，IMAP4]适用于多邮件客户端去邮件服务器获取邮件。

IMAP port为143，使用TCP与服务器进行连接；

IMAPS port为993，使用TLS/SSL进行连接。

#### IMAP常用命令

```c++
/*
Sample for IMAP
*/
C: <open connection>
S:   * OK IMAP4rev1 Service Ready
/*
命令输入：
  <随机字符串ID> command
响应：
  <随机字符串ID> OK <ANSWER DETAIL>
*/
C:   a001 login mrc secret
S:   a001 OK LOGIN completed
C:   a002 select inbox
S:   * 18 EXISTS
S:   * FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
S:   * 2 RECENT
S:   * OK [UNSEEN 17] Message 17 is the first unseen message
S:   * OK [UIDVALIDITY 3857529045] UIDs valid
S:   a002 OK [READ-WRITE] SELECT completed
C:   a003 fetch 12 full
S:   * 12 FETCH (FLAGS (\Seen) INTERNALDATE "17-Jul-1996 02:44:25 -0700"
      RFC822.SIZE 4286 ENVELOPE ("Wed, 17 Jul 1996 02:23:25 -0700 (PDT)"
      "IMAP4rev1 WG mtg summary and minutes"
      (("Terry Gray" NIL "gray" "cac.washington.edu"))
      (("Terry Gray" NIL "gray" "cac.washington.edu"))
      (("Terry Gray" NIL "gray" "cac.washington.edu"))
      ((NIL NIL "imap" "cac.washington.edu"))
      ((NIL NIL "minutes" "CNRI.Reston.VA.US")
      ("John Klensin" NIL "KLENSIN" "MIT.EDU")) NIL NIL
      "<B27397-0100000@cac.washington.edu>")
      BODY ("TEXT" "PLAIN" ("CHARSET" "US-ASCII") NIL NIL "7BIT" 3028
      92))
S:   a003 OK FETCH completed
C:   a004 fetch 12 body[header]
S:   * 12 FETCH (BODY[HEADER] {342}
S:   Date: Wed, 17 Jul 1996 02:23:25 -0700 (PDT)
S:   From: Terry Gray <gray@cac.washington.edu>
S:   Subject: IMAP4rev1 WG mtg summary and minutes
S:   To: imap@cac.washington.edu
S:   cc: minutes@CNRI.Reston.VA.US, John Klensin <KLENSIN@MIT.EDU>
S:   Message-Id: <B27397-0100000@cac.washington.edu>
S:   MIME-Version: 1.0
S:   Content-Type: TEXT/PLAIN; CHARSET=US-ASCII
S:
S:   )
S:   a004 OK FETCH completed
C    a005 store 12 +flags \deleted
S:   * 12 FETCH (FLAGS (\Seen \Deleted))
S:   a005 OK +FLAGS completed
C:   a006 logout
S:   * BYE IMAP4rev1 server terminating connection
S:   a006 OK LOGOUT completed
```

https://www.cnblogs.com/hujihon/p/5215367.html

`todo, 有需要时再细看吧`

#### POP3 vs IMAP

The [Internet Message Access Protocol](https://en.wikipedia.org/wiki/Internet_Message_Access_Protocol) (IMAP) is an alternative and more recent mailbox access protocol. The highlights of differences are:

- POP is a simpler protocol, making implementation easier.
- POP moves the message from the email server to the local computer, although there is usually an option to leave the messages on the email server as well.
- IMAP defaults to leaving the message on the email server, simply downloading a local copy.
- POP treats the mailbox as a single store, and has no concept of folders
- An IMAP client performs complex queries, asking the server for headers, or the bodies of specified messages, or to search for messages meeting certain criteria. Messages in the mail repository can be marked with various status flags (eg. "deleted" or "answered") and they stay in the repository until explicitly removed by the user—which may not be until a later session. In short: IMAP is designed to permit manipulation of remote mailboxes as if they were local. Depending on the IMAP client implementation and the mail architecture desired by the system manager, the user may save messages directly on the client machine, or save them on the server, or be given the choice of doing either.
- The POP protocol requires the currently connected client to be the **only client** connected to the mailbox. In contrast, the IMAP protocol specifically allows **simultaneous access by multiple clients** and provides mechanisms for clients to detect changes made to the mailbox by other, concurrently connected, clients. See for example RFC3501 section 5.2 which specifically cites "simultaneous access to the same mailbox by multiple agents" as an example.
- When POP retrieves a message, it receives all parts of it, whereas the **IMAP4 protocol allows clients to retrieve any of the individual MIME parts separately** – for example, retrieving the plain text without retrieving attached files.
- IMAP supports flags on the server to keep track of message state: for example, whether or not the message has been read, replied to, forwarded, or deleted.

### **SMTP(Simple Mail Transfer Protocol)**

https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol

https://www.samlogic.net/articles/smtp-commands-reference.htm

错误码： http://help.163.com/09/1224/17/5RAJ4LMH00753VB8.html

#### SMTP过程

```c++
// telnet连接mail server后，使用command发送邮件：
telnet SMTP.163.com 25
Trying 123.126.97.3...
Connected to SMTP.163.com.
Escape character is '^]'.
220 163.com Anti-spam GT for Coremail System (163com[20141201])
HELO SMTP.163.com
250 OK
AUTH LOGIN
334 dXNlcm5hbWU6
eWV5dW4wMTA4QDE2My5jb20=
334 UGFzc3dvcmQ6
*********
235 Authentication successful
MAIL FROM: <yeyun0108@163.com>
250 Mail OK
RCPT TO: <12344321@judytmdevorg.onmicrosoft.com>
250 Mail OK
DATA
354 End data with <CR><LF>.<CR><LF>
Date: Thu, 8 July 2021 04:01:03 +0800
From: Thanks <yeyun123@163.com>
Subject: Testing
To: 12344321@judytmdevorg.onmicrosoft.com

Hi This is a test Mail
Regards,
Ye
.
250 Mail OK queued as smtp3,G9xpCgBHwUxhne5gY10HGw--.25117S2 1626250676
QUIT
221 Bye
Connection closed by foreign host.

```

[接收到的邮件](./SMTP-command_mailHeaders.md)：

![image-20210714161956808](E:\Design Pattern\Learn-Web-Hacking\learning note\邮件安全基础知识.assets\image-20210714161956808.png)

## 垃圾邮件类型

Bulk mail vs Spam mail，比较类似

Spam mail: 垃圾邮件，不请自来，会持续的骚扰用户，mail server信誉差。 https://gatefy.com/blog/most-common-types-email-spam/

Bulk mail:  大批量的广告邮件，有人关注，有人认为是骚扰，一般是一次性广告或者营销信息。

Bounce Message（Non-Delivery Report, Non-Delivery Receipt）: 回退消息，邮件系统自动生成的，用于通知sender发送的邮件传送失败。回退消息可能是即时的，也可能延时很久。



## 攻击类型

### replay attack(**playback attack**)重播攻击

DKIM验证可能会被replay attack所利用： https://wordtothewise.com/2014/05/dkim-replay-attacks/

### Email Spoofing邮件伪造

在spam和phishing邮件中，经常会用到email spoofing对邮件的sender进行伪造，displayName显示为收件人信赖的个人或团体。https://en.wikipedia.org/wiki/Email_spoofing





It’s no wonder that phishing is one of today’s most prominent cyber attacks. Consider the following statistics:

3.1 billion domain spoofing emails are sent per day.
More than 90% of cyber-attacks start with an email message.
Email spoofing and phishing have had a worldwide impact costing an estimated $26 billion since 2016.
In 2019, the FBI reported that 467,000 cyber-attacks were successful, and 24% of them were email-based.
The average scam tricked users out of $75,000.



## 邮件安全认证相关协议

### 实例Samples

[ARC-Header-Sample](./ARC-headers.md)

### SPF(Sender Policy Framework)

SPF允许邮件接收服务器校验收到的邮件是否来自于它声称的domain——邮件发送端的host\IP是否为声称domain的。

SPF在2014.04的RFC7208中定义。

#### 原理

![image-20210712102439293](E:\Design Pattern\Learn-Web-Hacking\learning note\邮件安全基础知识.assets\image-20210712102439293.png)

1. SMTP允许发送邮件时，可以随意声称邮件的Source IP, 这一特性被spammers、scammers利用来伪造邮件地址，使得辨别邮件的真实发件地址变得难以确定。
2. SMTP中会先传送 envelope-from address(**MAIL FROM或者HELO命令中给出的address**)，SPF会进行DNS txt record查询，检测该envelope-from address中的domain是否允许send host\send IP发送邮件，如果不允许，则拒绝接受邮件的body（需要发送拒绝消息给envelope-from address，这样envelope-from address可以根据收到的消息，知晓被伪造了）。
3. 如果邮件服务器校验后，可以接收，则会接收邮件的body，并将envelop-from address插入到Return-Path Header中。

#### SPF TXT RECORD

SPF 记录其实就是一条有特殊语法的 TXT 记录，它由“匹配机制”和“修饰符”2 部分组成。“修饰符”通常只作为可选项，一般情况下 Exchange 管理员只会用到并处理包含“匹配机制”的 SPF 记录。[[4\]](https://zh.wikipedia.org/wiki/发件人策略框架#cite_note-4)

```c++
//SPF,v: version, ipxx: allowed send ip, a: allow, -all: forbiden other send ip 
//host.widgets.com只允许源ip为192.0.2.0/24，198.51.100.123，2620:0:860::/46的mail server发送邮件，其他源ip的mail server以host.widgets.com域名发送的邮件应全部拒绝。
example.com   IN     TXT   "v=spf1 ip4:192.0.2.0/24 ip4:198.51.100.123 ip6:2620:0:860::/46 a -all"
```

SPF 记录的匹配机制主要用于定义和指定可由该域名发送邮件的主机，其定义方式包括：

- **all** 匹配任何主机，它写在 SPF 记录最后以匹配在其前面所列出的主机。
- **ip4** 匹配 IPv4 地址或网络范围。
- **ip6** 匹配 IPv6 地址或网络范围。
- **a** 匹配主机名或域名。
- **mx** 匹配域名的 MX 记录，当出站与入站邮件为同一服务器时通常采用此种机制。
- **ptr** 通过 DNS 反向记录来匹配发件人 IP 和域名，由于会增加 DNS 负载，一般不采用此种机制。
- **exists** 只检查域是否在 DNS 中存在。
- **include** 将发件人 IP 和 SPF 记录指向另一个域，这种匹配机制通常用于云服务，如 Exchange Online Protection。

SPF 记录的匹配机制会结合一些限定词来使用，以告诉服务器找到一条匹配记录时该怎么办。常见的限定词有：

- **+** 放行，如果没有明确指定限定词，则为默认值。
- **-** 硬拒绝，直接拒绝来自未经授权主机的邮件【，然后此类型的邮件遵照接收服务器的配置垃圾邮件策略】。
- **~** 软拒绝，邮件可被接受，也可被标记为垃圾邮件【通常，电子邮件服务器配置为始终传递这些邮件。大多数最终用户不会看到此标记。】。
- **?** 中性，不考虑邮件是否被接受【通常将此选项保留用于测试，而且也很少使用】。

https://www.rivalsa.net/s/article/Network/spf

#### Add Headers

##### Received-SPF

The Received-SPF header field is a trace field (see [[RFC5322\]](https://tools.ietf.org/id/draft-ietf-spfbis-4408bis-09.html#RFC5322) Section 3.6.7) and SHOULD be prepended to the existing header, above the Received: field that is generated by the SMTP receiver. It MUST appear above all other Received-SPF fields in the message. The header field has the following format:

```assembly
header-field     = "Received-SPF:" [CFWS] result FWS [comment FWS]
                   [ key-value-list ] CRLF

result           = "pass" / "fail" / "softfail" / "neutral" /
                   "none" / "temperror" / "permerror"

key-value-list   = key-value-pair *( ";" [CFWS] key-value-pair )
                   [";"]

key-value-pair   = key [CFWS] "=" ( dot-atom / quoted-string )

key              = "client-ip" / "envelope-from" / "helo" /
                   "problem" / "receiver" / "identity" /
                    mechanism / name

identity         = "mailfrom"   ; for the "MAIL FROM" identity
                   / "helo"     ; for the "HELO" identity
                   / name       ; other identities
        
dot-atom         = <unquoted word as per [RFC5322]>
quoted-string    = <quoted string as per [RFC5322]>
comment          = <comment string as per [RFC5322]>
CFWS             = <comment or folding white space as per [RFC5322]>
FWS              = <folding white space as per [RFC5322]>
CRLF             = <standard end-of-line token as per [RFC2532]>
```

```assembly
Received-SPF: pass (mybox.example.org: domain of
 myname@example.com designates 192.0.2.1 as permitted sender)
    receiver=mybox.example.org; client-ip=192.0.2.1;
    envelope-from="myname@example.com"; helo=foo.example.com;

Received-SPF: fail (mybox.example.org: domain of
                  myname@example.com does not designate
                  192.0.2.1 as permitted sender)
                  identity=mailfrom; client-ip=192.0.2.1;
                  envelope-from="myname@example.com";
        
```

##### Authentication-Results

The Authentication-Results header field is designed to communicate lists of tests a border MTA did and their results. The specified elements of the field provide less information than the Received-SPF field:

```assembly
Authentication-Results: myhost.example.org; spf=pass
  smtp.mailfrom=example.net

Received-SPF: pass (myhost.example.org: domain of
 myname@example.com designates 192.0.2.1 as permitted sender)
    receiver=mybox.example.org; client-ip=192.0.2.1;
    envelope-from="myname@example.com"; helo=foo.example.com;
            
```

It is, however, possible to add CFWS in the "reason" part of an Authentication-Results header field and provide the equivalent information, if desired.

```assembly
Authentication-Results: myhost.example.org; spf=pass
  reason="client-ip=192.0.2.1; smtp.helo=foo.example.com" 
  smtp.mailfrom=user@example.net
            
```

As an example, an expanded Authentication-Results header field might look like (for a "MAIL FROM" check in this example):

##### Return-Path

SPF校验成功（PASS）时，MDA会将envelop-from address插入到Return-Path Header中。

#### 优缺点

优点：降低spam、phishing的概率，源envelope-from address可以及时知晓被伪造了；

缺点：在邮件转发时，会造成SPF验证失败的问题；需要结合DMARC、ARC使用。



### DKIM(DomainKeys Identified Mail)

DKIM允许邮件接收服务器根据邮件是否确实被某个特定domain进行了认证，来检查邮件是否确实来自于它所声称的某个特定domain。

邮件发送服务器会在每个发送出去的邮件中，添加上数字签名（digital signature),  用于保护邮件的一些部分（例如 **from[rfc强制要求的]**, Subject, body, attachment等）在签名后不会被改变。

邮件接收服务器根据sender DNS中的公钥对数字签名进行验证。

DKIM在2011.09的RFC6376中被定义，在RFC8301，RFC8463中被更新。

All of this is independent of [Simple Mail Transfer Protocol](https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol) (SMTP) routing aspects, in that it operates on the RFC 5322 message—the transported mail's header and body—not the SMTP "envelope" defined in RFC 5321. Hence, DKIM signatures survive basic relaying across multiple [MTAs](https://en.wikipedia.org/wiki/Message_transfer_agent).

DKIM签名的是邮件本身的信息，在多个MTAs中转时，邮件“Envelope”的变动不会影响数字签名结果。但是如果邮件本身被更改，例如Subject Tag，则数字签名会校验失败。

- RFC 4686 Analysis of Threats Motivating DomainKeys Identified Mail (DKIM)
- RFC 4871 DomainKeys Identified Mail (DKIM) Signatures *Proposed Standard*
- RFC 5617 DomainKeys Identified Mail (DKIM) Author Domain Signing Practices (ADSP)
- RFC 5585 DomainKeys Identified Mail (DKIM) Service Overview
- RFC 5672 RFC 4871 DomainKeys Identified Mail (DKIM) Signatures—Update
- RFC 5863 DKIM Development, Deployment, and Operations
- RFC 6376 DomainKeys Identified Mail (DKIM) Signatures *Draft Standard*
- RFC 6377 DomainKeys Identified Mail (DKIM) and Mailing Lists
- RFC 8301 Cryptographic Algorithm and Key Usage Update to DomainKeys Identified Mail (DKIM)

#### DIKM-Signature Headers

签名模块会插入一个或多个DKIM-Signature Header, 由tag=value组成：

v= version

a= signing algorithm签名算法

c= [canonicalization](https://en.wikipedia.org/wiki/Canonicalization) algorithm(s) for header and body 规范化算法 header/body， 可选，默认为simple/simple

   [ https://wordtothewise.com/2016/12/dkim-canonicalization-or-why-microsoft-breaks-your-mail/

​     header和body有simple，relaxed两种规范化算法，

​	 对于header: simple不做任何改动，relaxed会将所有header字段转为小写，每个header为单行，去除尾部空白符，所有空白符由空格替换；

​    对于body: simple会去除空行，relaxed会去除空行，所有空白符由空格替换;

​    所以relaxed健壮性更好，推荐relaxed。

   但是如果存在ASCII-Art attack的风险，则使用simple更合适]

d= domain

s= selector

q= default query method

t= signature timestamp

x= expire time

h= header fields - list of those that have been signed 签名的header list

l= body length, 规范化后需要进行bh的body长度，可选项，默认是整个body

bh= body hash

b= signature of headers and body，所有header list+body的签名校验

| Samples                                                      |
| ------------------------------------------------------------ |
| DKIM-Signature: v=1; a=rsa-sha256; d=example.com; s=brisbane;<br/>     c=relaxed/simple; q=dns/txt; t=1117574938; x=1118006938;<br/>     h=from:to:subject: date:keywords:keywords;<br/>     bh=MTIzNDU2Nzg5MDEyMzQ1Njc4OTAxMjM0NTY3ODkwMTI=;<br/>     b=dzdVyOfAKCdLXdJOc9G2q8LoXSlEniSbav+yuU4zGeeruD00lszZVoG4ZHRNiYzR |

#### DKIM TXT RECORD

DKIM TXT record的一般形式为：

​    <selector>._domainkey.<domainInfo>           publicKey

`<selector>` identifies what key you are using and can be used for multiple keys, so it's possible to have more than one DKIM record as long as the correct selector is used.

It's recommended to rotate your public key at least once a year for security purposes, so remember to change the **Value** in your DNS records to reflect this change.

In this example, `brisbane._domainkey` was the provided selector entered into the **Name** field and the provided public key was entered into the **Value** field. 

```C++
// DKIM, k: cryto, t: , p: publick key
brisbane._domainkey.example.com   IN     TXT   "k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDmzRmJRQxLEuyYiyMg4suA2Sy MwR5MGHpP9diNT1hRiwUd/mZp1ro7kIDTKS8ttkI6z6eTRW9e9dDOxzSxNuXmume60Cjbu08gOyhPG3GfWdg7QkdN6kR4V75MFlw624VY35DaXBvnlTJTgRg/EW72O1DiYVThkyCgpSYS8nmEQIDAQAB"
```

https://help.returnpath.com/hc/en-us/articles/222481088-DKIM-DNS-record-overview

**Required tag**

- p= is the public key used by a mailbox provider to match to the DKIM signature generated using the private key. The value is a string of characters representing the public key. It is generated along with its corresponding private key during the DKIM set-up process.

**Recommended optional tags**

- v= is the version of the DKIM record. The value must be DKIM1 and be the first tag in the DNS record.

- t= indicates the domain is testing DKIM or is enforcing a domain match in the signature header between the "i=" and "d=" tags.

- - t=y indicates the domain is testing DKIM. Senders use this tag when first setting up DKIM to ensure the DKIM signature is verifying correctly. Some mailbox providers ignore a DKIM signature in test mode, so this tag should be removed prior to full deployment or changed to t=s if using the "i=" tag in the DKIM signature header.
  - t=s indicates that any DKIM signature header using the "i=" tag must have the same domain value on the right-hand side of the @ sign in the "i=" tag and the "d=" tag (i= local-part@domain.com). The "i=" tag  domain must not be a subdomain of the "d=" tag. Do not include this tag if the use of a subdomain is required.

**Optional tags**

- g= is the granularity of the public key. The value must match the local-part of the i= flag in the DKIM signature field (i= local-part@domain.com) or contain a wildcard asterisk (*). The use of this flag is intended to constrain which signing address can use the selector record.
- h= indicates which hash algorithms are acceptable. The default value is to allow for all algorithms but you can specify sha1 and sha256. Signers and verifiers must support sha256. Verifiers must also support sha1.
- k= indicates the key type. The default value is rsa which must be supported by both signers and verifiers.
- n= is a note field intended for administrators, not end users. The default value is empty and may contain a note that an administrator may want to read.
- s= indicates the service type to which this record applies. The default value is a wildcard asterisk (*) which matches all service types. The other acceptable value allowed is the word "email" which indicates that the message is an electronic mail message. This tag is not the same as a selector record. It is intended to constrain the use of keys if DKIM is used for other purposes other than email in the future. If used, it is included in the DKIM DNS TXT record and not the DKIM signature. Should other service types be defined in the future, verifiers will ignore the DKIM record if it does not match the type of message sent.

#### DKIM生成步骤

1. 邮件body被hash, 经过Base64转码，得到bh值：body规范化后从body beginning开始，截取特定长度(l=, 可以为0)进行hash；
2. 按照h=列出的顺序，对选定的headers规范化后进行hash：
   1. 如果header重复，从后向前匹配；
   2. 如果header不存在，则为空串[因此，如果后续添加了该header，则数字签名会校验失败]
3. hash结果由domain private key加密有，经过Base64转码，得到b

#### DKIM校验步骤

1. 邮件接收服务器通过**selector + "._domainkey." + domain信息**进行DNS查询**TXT Record**[可能需要进行编码转换]

   ```assembly
   "k=rsa; t=s; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDmzRmJRQxLEuyYiyMg4suA2SyMwR5MGHpP9diNT1hRiwUd/mZp1ro7kIDTKS8ttkI6z6eTRW9e9dDOxzSxNuXmume60Cjbu08gOyhPG3GfWdg7QkdN6kR4V75MFlw624VY35DaXBvnlTJTgRg/EW72O1DiYVThkyCgpSYS8nmEQIDAQAB"
   ```

2. 邮件接收器根据public key校验数字签名和当前mail的header+body hash值是否一致。

3. 如果校验失败，并不会强制回退该邮件【需要结合DMARC设定】，校验失败的详细原因会发送给上下游邮件服务器，例如返回 [FBL message](https://en.wikipedia.org/wiki/Feedback_Loop_(email)),或者在邮件header中**添加 Authentication-Results**。

   ```assembly
   Authentication-Results: <contoso.com>; dkim=pass (signature was verified) header.d=example.com;
   ```

#### 优缺点

优点：

​    降低domain伪造、滥用，可以降低spam mail、phishing mail；

缺点：

   https://datatracker.ietf.org/doc/html/rfc6376#section-8 潜在的漏洞攻击方式

   在MTA转发过程中，如果邮件内容、header被修改了，则可能导致DKIM校验失败



### DMARC

DMARC (Domain-based Message Authentication, Reporting and Conformance)  is defined in the [Internet Engineering Task Force](https://en.wikipedia.org/wiki/Internet_Engineering_Task_Force)'s published document RFC 7489, dated March 2015, as "Informational".[[2\]](https://en.wikipedia.org/wiki/DMARC#cite_note-rfc7489-2)

SPF、DKIM提供了邮件认证方法，DMARC提供了邮件服务器配置邮件认证的policy（DNS TXT Record）【可以选择SPF或者DKIM，或者SPF+DKIM; 校验失败时的处理方式（消息回传、action），也可以设置检验成功的消息回传。】

#### DMARC TXT Record

DMARC records are published in DNS with a subdomain label `_dmarc`, for example `_dmarc.example.com`. Compare this to SPF at `example.com`, and DKIM at `selector._domainkey.example.com`.

The content of the TXT resource record consists of `name=value` tags, separated by semicolons, similar to SPF and DKIM. For example:

```c++
_dmarc.example.com IN     TXT "v=DMARC1; p=reject; rua=mailto:postmaster@solarmora.com, mailto:dmarc@solarmora.com; pct=100; adkim=s; aspf=s"
```

| **Tag**   | **Required?** | **Description and values**                                   |
| --------- | ------------- | ------------------------------------------------------------ |
| **v**     | Required      | DMARC version. Must be **DMARC1**.                           |
| **p**     | Required      | Instructs the receiving mail server what to do with messages that don’t pass authentication.<br />**none -** Take no action on the message and deliver it to the intended recipient. Log messages in a daily report. The report is sent to the email address specified with the **rua** option in the record.<br />**quarantine -**Mark the messages as spam and send it to the recipient's spam folder. Recipients can review spam messages to identify legitimate messages.<br />**reject -** Reject the message. With this option, the receiving server usually sends a bounce message to the sending server.<br />**BIMI note:** If your domain uses [BIMI](https://support.google.com/a/topic/10911234), the DMARC **p** option must be set to **quarantine** or **reject**. BIMI doesn't support DMARC policies with the **p** option set to **none**. |
| **pct**   | Optional      | Specifies the percent of unauthenticated messages are subject to the DMARC policy. When you gradually deploy DMARC, you might start with a small percentage of your messages. As more messages from your domain pass authentication with receiving servers, update your record with a higher percentage, until you reach 100 percent.Must be a whole number from **1** to **100**. If you don’t use this option in the record, your DMARC policy applies to 100% of messages sent from your domain.<br />**BIMI note:** If your domain uses [BIMI](https://support.google.com/a/topic/10911234), your DMARC policy must have a **pct** value of **100**. BIMI doesn't support DMARC policies with the **pct** value set to less than 100. |
| **rua**   | Optional      | Email address to receive reports about DMARC activity for your domain.The email address must include **mailto:**. For example: `mailto:dmarc-reports@solarmora.com`To send the report to more than one email address, separate emails with a comma.This option can potentially result in a high volume of report emails. We don’t recommend using your own email address. Instead, consider using a dedicated mailbox, a group, or a third-party service that specializes in DMARC reports. |
| **ruf**   | Not supported | used to send failure reports. Failure reports are also called forensic reports. 【Gmail doesn’t support the **ruf** tag】 |
| **sp**    | Optional      | Sets the policy for messages from subdomains of your primary domain. Use this option if you want to use a different DMARC policy for your subdomains.<br />**none -** Take no action on the message and deliver it to the intended recipient. Log messages in a daily report. The report is sent to the email address specified with the **rua** option in the policy .<br />**quarantine -** Mark the messages as spam and send it to the recipient's spam folder. Recipients can review spam messages to identify legitimate messages.<br />**reject -** Reject the message. With this option, the receiving server should send a bounce message to the sending serverIf you don’t use this option in the record, subdomains inherit the DMARC policy set for the parent domain. |
| **adkim** | Optional      | Sets the alignment policy for DKIM, which defines how strictly message information must match DKIM signatures. Learn [how alignment works](https://support.google.com/a/answer/10032169#alignment).<br />**s -** Strict alignment. The sender domain name must exactly match the corresponding **d=\*domainname\*** in the DKIM mail headers.<br />**r -** Relaxed alignment (default). Allows partial matches. Any valid subdomain of **d=\*domain\*** in the DKIM mail headers is accepted. |
| **aspf**  | Optional      | Sets the alignment policy for SPF, which specifies how strictly message information must match SPF signatures. Learn [how alignment works](https://support.google.com/a/answer/10032169#alignment).<br />**s -** Strict alignment. The message **From** header must exactly match the domain name in the SMTP MAIL FROM command<br />**r -** Relaxed alignment (default). Allows partial matches. Any valid subdomain of domain name is accepted. |

#### DMARC说明

Like SPF and DKIM, DMARC uses the concept of a domain owner, the entity or entities that are authorized to make changes to a given DNS domain.

SPF checks that the IP address of the sending server is authorized by the owner of the domain that appears in the SMTP `MAIL FROM` command. (The email address in MAIL FROM is also called the [bounce address](https://en.wikipedia.org/wiki/Bounce_address), envelope-from or RFC5321.MailFrom.) In addition to requiring that the SPF check pass, **DMARC additionally checks that RFC5321.MailFrom aligns with 5322.From.**[*[citation needed](https://en.wikipedia.org/wiki/Wikipedia:Citation_needed)*]

DKIM allows parts of an email message to be cryptographically signed, and *the signature must cover the From field.* Within the DKIM-Signature mail header, the `d=` (domain) and `s=` (selector) tags specify where in DNS to retrieve the public key for the signature. A valid signature proves that the signer is a domain owner, and that the From field hasn't been modified since the signature was applied. There may be several DKIM signatures on an email message; **DMARC requires one valid signature where the domain in the `d=` tag aligns with the sender's domain stated in the `From:` header field**.

DMARC**额外要求**:

1. SPF的envelope address[return-path]和header中的from一致；
2. DKIM中的d=domainxxx与header中的from字段一致，

匹配要求见上方的adkim、aspf设置。

To pass DMARC, a message must pass at least one of these checks: https://support.google.com/a/answer/10032169#alignment

- SPF authentication and SPF alignment
- DKIM authentication and DKIM alignment

| **Authentication method** | **Strict alignment**                                         | **Relaxed alignment**                                        |
| ------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| SPF                       | An exact match between the SPF authenticated domain[envelop address即return-path], and the domain in the header **From:** address. | The domain in the header From: address must match or be a subdomain of the SPF authenticated domain. |
| DKIM                      | An exact match between the relevant DKIM domain[`d`=tag], and the domain in the header **From:** address. | The domain in the header From: address must match or be a subdomain of the domain specified in the DKIM signature **d=** tag. |

#### 优缺点

优点： 有效防止伪造邮件、钓鱼邮件，可以对spf、dkim的校验结果进行report

缺点： 无法防止转发过程中，spf、dkim校验失败的问题



### ARC(Authenticated Received Chain)

https://en.wikipedia.org/wiki/Authenticated_Received_Chain

https://dmarc.org/presentations/ARC-Overview-2016Q3-v01.pdf

https://datatracker.ietf.org/doc/html/rfc8617

DMARC可能会block通过邮件中转器中转的合法邮件，因为SPF会认为中转的sender不是approved sender, DKIM signature可能会因为中转器对邮件信息的修改(例如添加subject tag, footer)而验证失败。

ARC是为了解决上述问题提出的方案，它允许中转器记录上一条的邮件验证结果(SPF, DKIM), 这样在DMARC、SPF、DKIM验证失败时，可以通过验证ARC判断原始邮件是否通过了SPF、DKIM校验，修改邮件的邮件中转器是否为可信任的中转器。

ARC在2019.07发布的RFC8617中定义，目前是“Experimental”.

![image-20210518171812836](E:\Design Pattern\Learn-Web-Hacking\learning note\邮件安全基础知识.assets\image-20210518171812836.png)

#### ARC Headers

##### **ARC-Authentication-Results** (AAR)

​	A combination of an instance number (i) and the results of the SPF, DKIM, and DMARC validation

i= 标志当前ARC-headers的链数

| Samples                                                      |
| ------------------------------------------------------------ |
| ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass<br/> smtp.mailfrom=itstrategy.it; dmarc=pass action=none<br/> header.from=itstrategy.it; dkim=pass header.d=itstrategy.it; arc=none |
| ARC-Authentication-Results: i=2; mx.microsoft.com 1; spf=pass (sender ip is<br/> 40.107.0.80) smtp.rcpttodomain=battistolli.it smtp.mailfrom=itstrategy.it;<br/> dmarc=pass (p=reject sp=none pct=100) action=none header.from=itstrategy.it;<br/> dkim=pass (signature was verified) header.d=itstrategy.it; arc=pass (0 oda=1<br/> ltdi=1 spf=[1,1,smtp.mailfrom=itstrategy.it]<br/> dkim=[1,1,header.d=itstrategy.it] dmarc=[1,1,header.from=itstrategy.it]) |

##### **ARC-Seal** (AS) 

​    A combination of an instance number (i), a DKIM-like signature of the previous ARC headers, and the **validity of the prior ARC entries.**

i= 标志当前ARC-headers的链数

b= 所有ARC- header的签名校验

a= d= s= 和DKIM的tag一致

​	a= signing algorithm签名算法

​    d= domain

​    s= selector

cv= 显示ARC链是否被中转器校验过

| Samples                                                      |
| ------------------------------------------------------------ |
| ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;<br/> b=BS//C15nmrHKK7XfE5Il7HmDDLL1g9/F7b0sreVTHJzPEcWnMiywvfFpfuQO3YZTIkdG0rIPxm5ushcAyq8CPrJSUUOCcgD9d98AfIC3n/OMW3wFWvxoC9K9nK5/L+0889UqHDK9BzxLWRfR4sbLzmPVs3PVfyywd1rg0j61JtFAMEZ5cB1aEfaYXgKQTFTp1mUp8M2cNW35LAQYFPST34F3QB4Ioz3WifL6dASmTpW0DEQnykQL7XEbMHty3pVGaeHV1+pOTW/u2OfqcutxSMt7NjgPZFRy+7+ooCCSG9l7raslPNhcfs0VP5Z5AUREVvBm+bhx1NQD7+hhQaoiNw== |
| ARC-Seal: i=2; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=pass;<br/> b=CO7PqBuffA52Wzx6S1+fnIIIR6V3dREhjtrnaxAnKMNDKuVkP2gQyCVHICEDYtTCPrRixZ2EsRd59FPLtg+9TuGHwD6lbMvuDuKj09iOM51Q/wH+48uWSUEO4fuJ0DonC4H+4JGeSmqkOpPC7207hGEuhaJh78ZeiqNjsXYOJMVrZoTy7OXSTRp15M/wzBElGsuAEhznqLvXkoiSZxOU0DksD9AhV9ukoY7bfRZ9HPny14/yR8dOuXVtPgxLjYSGYYPZt2dogPb+i/ER3xUM5a84TLE0GU30G5//y1fiRGieOgkNmtOmfsRYmd9Md7nBuWIx31F4plcM3SNbOxhCBQ== |

##### **ARC-Message-Signature** (AMS) 

   A combination of an instance number (i) and a DKIM-like **signature of the entire message *except* for the ARC-Seal headers**

i= 标志当前ARC-headers的链数

基本和DKIM的tag一致

​	a= signing algorithm签名算法

​    d= domain

​    s= selector

​    c= [canonicalization](https://en.wikipedia.org/wiki/Canonicalization) algorithm(s) for header and body 规范化算法 header/body

​    h= header fields - list of those that have been signed 签名的header list

​    bh= body hash

​    b= signature of headers and body，所有ARC- header[除了ARC-Seal Headers]+ header list + body的签名校验

**Should not be usable as a DKIM signature in a replay attack**[因为会首先校验AS header]

| Samples                                                      |
| ------------------------------------------------------------ |
| ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;<br/> s=arcselector9901;<br/> h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;<br/> bh=6aRaLyQ9ADwfDtg6vXcLynE4LmsRwYAOAxbOiVO5bC0=;<br/> b=djOgI9vG8zPaZectXdss9tEY0WI/Mu+VYzSn0DU1RYJb6WV0iNasSWWSa9k7b4+3tKbebwpP1r3S6xgBebVT42tQmD2EcM9GbcbXISDXUfNARMs/xqTNtP0IZ7wCtLVtTIfDkkopNPmQPJQM11Al1eH5KVSOCx8ENVr+F0PMuK5V/zwwAjUqTZ7UTt4bJ+lF2wM1h5CIq3GE0SKVkhdwmoOR7ZNMXl+24CejcOeVbPYtTVFP2Jk0EcljFf2LWsHX9pmZ2rJragTARzgU+svoNLacs6Ic3Vwg4oEaI4uhCU0VVoyg2O/qTdzCn947Nm2uVJMmLYEuZvpFpWgQonyBrA== |
| ARC-Message-Signature: i=2; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;<br/> s=arcselector9901;<br/> h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;<br/> bh=6aRaLyQ9ADwfDtg6vXcLynE4LmsRwYAOAxbOiVO5bC0=;<br/> b=LgNnx6hBO6mdTQpsEBtggpUJ/KRxCOX8eOkGqRARQYbzPbsZTz38qziQNA3Nt7ch8Rt7peYbOPPYxLNwqDIBDkmkYUV+r7aW/m5xDNEenKbLkj1gCrTkGIvQD3s3aEm6b11KZWeU+3bf5VPv4PcFa88B40e0eGOaBe2wUPwcfE7+kbAT8XmDz2es+6Z8oWg5X4tdY7rxgWYQeaCIsISaqMwK+0xmt4QOWKtUkIOUjnWW21ikW64k3ricClYtFCzJ/GkpxtaNsjEW1PZqna+P3Rz9BgFa9+F4nTOMAqV4wtbuah3LtZ6pBH7uu71hgN4TZ4EZ2DTG+HoAV6boEM0v8g== |

#### ARC生成步骤

To sign a modification, an intermediate server performs the following steps:

- **Copies the "Authentication-Results" field into a new AAR field** (starting with i=1) and prefixed to the message.
- **Calculates the AMS for the message (with the AAR, exclude all AS headers)** and prepends it to the message.
- **Calculates the AS for the previous Arc headers** and prepends it to the message.
- ARC headers prefixed per common practice, but order of appearance is not critical for validation

![image-20210518171851155](E:\Design Pattern\Learn-Web-Hacking\learning note\邮件安全基础知识.assets\image-20210518171851155.png)

`*但实际上邮件中的header, DIKM-Signature似乎没有很多个, 不清楚什么原因*`

#### ARC校验步骤

To validate an ARC, the recipient performs the following steps:

- Validates the chain of ARC-Seal headers (no missing entries, all ARC-Seal messages state that the prior ARC entries are valid, etc.)
  - All ARC-Seal: headers must validate 
  - Method used by each participant to determine the cv= value in their ARC-Seal: the cv= value for those AS headers must be Pass 
- Validates the newest ARC-Message-Signature (based on the instance number, highest i)

#### 什么时候需要添加ARC

- ​	会改变DKIM 签名时：
  - 插入Subject tag
  - 插入disclaimers(免责声明) and footers(页脚)
  - 删除附件
  - 改变content-encoding

![image-20210518154436744](E:\Design Pattern\Learn-Web-Hacking\learning note\邮件安全基础知识.assets\image-20210518154436744.png)



## EOP header(Exchange Online Protection Header)

https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-spam-message-headers?view=o365-worldwide

扫描范围： all incoming messages【这里的incoming指收到的邮件，和CAS的非Internal mail as Incoming mail存在差别】

​                                                            【send out mail没有Internet Headers】

保护范围： spam, malware, and other threats

添加的headers:

X-Forefront-Antispam-Report:  包含邮件的信息及它的处理信息

X-Microsoft-Antispam:  包含关于bulk mail、phishing的信息

Authentication-results： 包含SPF、DKIM、DMARC的结果

https://www.codetwo.com/userguide/email-signatures-for-office-365/spf-records.htm

### X-Forefront-Antispam-Report

| Field                       | Description                                                  |
| :-------------------------- | :----------------------------------------------------------- |
| `ARC`                       | The `ARC` protocol has the following fields:<br />`AAR`: Records the content of the **Authentication-results** header from DMARC.<br />`AMS`: Includes cryptographic signatures of the message.<br />`AS`: Includes cryptographic signatures of the message headers. This field contains a tag of a chain validation called `"cv="`, which includes the outcome of the chain validation as **none**, **pass**, or **fail**. |
| `CAT:`                      | The category of protection policy, applied to the message:<br />`BULK`: Bulk<br />`DIMP`: Domain Impersonation<br />`GIMP`: [Mailbox intelligence based impersonation](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/set-up-anti-phishing-policies?view=o365-worldwide#impersonation-settings-in-anti-phishing-policies-in-microsoft-defender-for-office-365)<br />`HPHSH` or `HPHISH` : High confidence phishing`HSPM`: High confidence spam<br />`MALW`: Malware`PHSH`: Phishing`SPM`: Spam`SPOOF`: Spoofing<br />`UIMP`: User Impersonation<br />`AMP`: Anti-malware<br />`SAP`: Safe attachments<br />`OSPM`: Outbound spam<br />An inbound message may be flagged by multiple forms of protection and multiple detection scans. Policies have different priorities, and the policy with the highest priority is applied first. For more information, see [What policy applies when multiple protection methods and detection scans run on your email](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/how-policies-and-protections-are-combined?view=o365-worldwide). |
| `CIP:[IP address]`          | The connecting IP address. You can use this IP address in the IP Allow List or the IP Block List. For more information, see [Configure connection filtering](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/configure-the-connection-filter-policy?view=o365-worldwide). |
| `CTRY`                      | The source country as determined by the connecting IP address, which may not be the same as the originating sending IP address. |
| `H:[helostring]`            | The HELO or EHLO string of the connecting email server.      |
| `IPV:CAL`                   | The message skipped spam filtering because the source IP address was in the IP Allow List. For more information, see [Configure connection filtering](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/configure-the-connection-filter-policy?view=o365-worldwide). |
| `IPV:NLI`                   | The IP address was not found on any IP reputation list.      |
| `LANG`                      | The language in which the message was written, as specified by the country code (for example, ru_RU for Russian). |
| `PTR:[ReverseDNS]`          | The PTR record (also known as the reverse DNS lookup) of the source IP address. |
| `SCL`                       | The spam confidence level (SCL) of the message. A higher value indicates the message is more likely to be spam. For more information, see [Spam confidence level (SCL)](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/spam-confidence-levels?view=o365-worldwide).<br />-1 = A special value that means the message is a safe sender and is not spam. This score tells Microsoft to put the message in the inbox. <br />0-1 = The content of the message was scanned and determined to not be spam. These two scores also tell Microsoft to deliver the message to the inbox. <br />5-9 = Starting with a score of 5 the message is suspected to be spam and is increasingly suspect to the highest score of 9 which indicates there’s a high confidence it’s spam. Any rating between 5 and 9 means the message should be sent to the Junk folder.<br />*Note: 2, 3, 4, 7, and 8 are ratings that are not assigned by Microsoft.* |
| `SFTY`                      | 9.19: Domain impersonation. The sending domain is attempting to [impersonate a protected domain](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/set-up-anti-phishing-policies?view=o365-worldwide#impersonation-settings-in-anti-phishing-policies-in-microsoft-defender-for-office-365). The safety tip for domain impersonation is added to the message (if it's enabled).<br />9.20: User impersonation. The sending user is attempting to impersonate a user in the recipient's organization, or [a protected user that's specified in an anti-phishing policy](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/set-up-anti-phishing-policies?view=o365-worldwide#impersonation-settings-in-anti-phishing-policies-in-microsoft-defender-for-office-365) in Microsoft Defender for office 365. The safety tip for user impersonation is added to the message (if it's enabled). |
| `SFV:BLK`                   | Filtering was skipped and the message was blocked because it was sent from an address in a user's Blocked Senders list.<br />For more information about how admins can manage a user's Blocked Senders list, see [Configure junk email settings on Exchange Online mailboxes](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/configure-junk-email-settings-on-exo-mailboxes?view=o365-worldwide). |
| `SFV:NSPM`                  | Spam filtering marked the message as non-spam and the message was sent to the intended recipients. |
| `SFV:SFE`                   | Filtering was skipped and the message was allowed because it was sent from an address in a user's Safe Senders list.<br />For more information about how admins can manage a user's Safe Senders list, see [Configure junk email settings on Exchange Online mailboxes](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/configure-junk-email-settings-on-exo-mailboxes?view=o365-worldwide). |
| `SFV:SKA`                   | The message skipped spam filtering and was delivered to the Inbox because the sender was in the allowed senders list or allowed domains list in an anti-spam policy. <br />For more information, see [Configure anti-spam policies](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/configure-your-spam-filter-policies?view=o365-worldwide). |
| `SFV:SKB`                   | The message was marked as spam because it matched a sender in the blocked senders list or blocked domains list in an anti-spam policy. <br />For more information, see [Configure anti-spam policies](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/configure-your-spam-filter-policies?view=o365-worldwide). |
| `SFV:SKI`                   | Similar to SFV:SKN, the message skipped spam filtering for another reason (for example, an intra-organizational email within a tenant). |
| `SFV:SKN`                   | The message was marked as non-spam prior to being processed by spam filtering. For example, the message was marked as SCL -1 or **Bypass spam filtering** by a mail flow rule. |
| `SFV:SKQ`                   | The message was released from the quarantine and was sent to the intended recipients. |
| `SFV:SKS`                   | The message was marked as spam prior to being processed by spam filtering. For example, the message was marked as SCL 5 to 9 by a mail flow rule. |
| `SFV:SPM`                   | The message was marked as spam by spam filtering.            |
| `SRV:BULK`                  | The message was identified as bulk email by spam filtering and the bulk complaint level (BCL) threshold. When the *MarkAsSpamBulkMail* parameter is `On` (it's on by default), a bulk email message is marked as high confidence spam (SCL 9). <br />For more information, see [Configure anti-spam policies](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/configure-your-spam-filter-policies?view=o365-worldwide). |
| `X-CustomSpam: [ASFOption]` | The message matched an Advanced Spam Filter (ASF) setting. To see the X-header value for each ASF setting, see [Advanced Spam Filter (ASF) settings](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/advanced-spam-filtering-asf-options?view=o365-worldwide). |
| SFS                         | This denotes that spam rules were matched.                   |



### X-Microsoft-Antispam

| Field | Description                                                  |
| :---- | :----------------------------------------------------------- |
| `BCL` | The **bulk complaint level (BCL)** of the message. A higher BCL indicates a bulk mail message is more likely to generate complaints (and is therefore more likely to be spam). For more information, see [Bulk complaint level (BCL)](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/bulk-complaint-level-values?view=o365-worldwide). |

The BCL thresholds are described in the following table.

------

|     BCL     | Description                                                  |
| :---------: | :----------------------------------------------------------- |
|      0      | The message isn't from a bulk sender.                        |
|   1, 2, 3   | The message is from a bulk sender that generates few complaints. |
| 4, 5, 6, 7* | The message is from a bulk sender that generates a mixed number of complaints. |
|    8, 9     | The message is from a bulk sender that generates a high number of complaints. |

\* This is the default threshold value that's used in anti-spam policies.

---------------------------------------------

**PCL**

This rating simply determines how likely the message is a phishing message based on the content. These range from:

0-3 = Not likely to be phishing.
4-8 = Likely to be phishing and marked as suspicious content.

For more information, refer to [Microsoft’s official documentation on PCL](https://technet.microsoft.com/en-us/library/dn205071(v=exchg.150).aspx?f=255&MSPPError=-2147217396#Anchor_1).

### Authentication-results

- SPF uses the following syntax:

  ```text
  spf=<pass (IP address)|fail (IP address)|softfail (reason)|neutral|none|temperror|permerror> smtp.mailfrom=<domain>
  ```

  For example:

  ```text
  spf=pass (sender IP is 192.168.0.1) smtp.mailfrom=contoso.com
  spf=fail (sender IP is 127.0.0.1) smtp.mailfrom=contoso.com
  ```

- DKIM uses the following syntax:

  ```text
  dkim=<pass|fail (reason)|none> header.d=<domain>
  ```

  For example:

  ```text
  dkim=pass (signature was verified) header.d=contoso.com
  dkim=fail (body hash did not verify) header.d=contoso.com
  ```

- DMARC uses the following syntax:

  ```text
  dmarc=<pass|fail|bestguesspass|none> action=<permerror|temperror|oreject|pct.quarantine|pct.reject> header.from=<domain>
  ```

  For example:

  ```text
  dmarc=pass action=none header.from=contoso.com
  dmarc=bestguesspass action=none header.from=contoso.com
  dmarc=fail action=none header.from=contoso.com
  dmarc=fail action=oreject header.from=contoso.com
  ```



## 其它保护方法

### Context Filtering

使用黑名单（DNSBL(Domain Name System Black List)、IP blacklist）的方式，直接不接收黑名单的邮件（可能会影响邮件数量的统计信息）。黑名单的方式只有很小的FP\FN，可以节省带宽、服务器负荷，不过防护效果主要和黑名单有效性关联。







### 

